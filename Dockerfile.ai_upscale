# netv with AI Upscale (TensorRT super-resolution)
#
# This image includes everything needed for AI upscaling:
# - FFmpeg with TensorRT DNN backend
# - Python + torch + tensorrt for building engines
# - Auto-builds TensorRT engines on first start (GPU-specific)
#
# REQUIREMENTS:
#   - Docker BuildKit (DOCKER_BUILDKIT=1 or use docker buildx)
#   - NVIDIA GPU with 8GB+ VRAM recommended
#   - nvidia-container-toolkit installed on host
#
# Build:
#   docker build -f Dockerfile.ai_upscale -t netv-ai-upscale .
#
# Run (engines are cached in volume):
#   docker run --gpus all -v netv-models:/models -p 8000:8000 netv-ai-upscale
#
# Note: First start takes ~2-3 minutes to build TensorRT engines for your GPU.
# Subsequent starts are instant (engines cached in /models volume).

ARG FFMPEG_IMAGE=ghcr.io/jvdillon/netv-ffmpeg:latest
FROM ${FFMPEG_IMAGE}

# Build metadata (passed from workflow, used for documentation/debugging)
ARG NVIDIA=cuda:13.0
ARG BASE_IMAGE=ubuntu:24.04

# Store build info as labels
LABEL org.opencontainers.image.description="netv with AI Upscale (TensorRT)"
LABEL ai.netv.cuda="${NVIDIA}"
LABEL ai.netv.base="${BASE_IMAGE}"

ENV DEBIAN_FRONTEND=noninteractive

# Install dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    gosu \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# App setup
WORKDIR /app

# Copy application files with verification
COPY pyproject.toml README.md ./
COPY *.py ./
COPY templates/ templates/
COPY static/ static/
COPY tools/ tools/

# Verify critical files exist
RUN test -f pyproject.toml || { echo "ERROR: pyproject.toml not found"; exit 1; } && \
    test -f tools/export-tensorrt.py || { echo "ERROR: export-tensorrt.py not found"; exit 1; }

# Install Python dependencies with version constraints for stability
# --ignore-installed: avoids "Cannot uninstall X, RECORD file not found" for apt packages
# --break-system-packages: required for PEP 668 (Ubuntu 24.04+), doesn't exist in pip 22.0 (Ubuntu 22.04)
# Version constraints: use compatible versions that work together
RUN if python3 -m pip install --help 2>&1 | grep -q -- '--break-system-packages'; then \
        PIP_OPTS="--no-cache-dir --ignore-installed --break-system-packages"; \
    else \
        PIP_OPTS="--no-cache-dir --ignore-installed"; \
    fi && \
    # Install with minimum version constraints for compatibility
    python3 -m pip install $PIP_OPTS \
        'torch>=2.1.0' \
        'onnx>=1.14.0' \
        'tensorrt>=9.0' \
        . && \
    # Verify packages installed correctly
    python3 -c "import torch; import onnx; import tensorrt; print(f'Installed: torch={torch.__version__}, onnx={onnx.__version__}, tensorrt={tensorrt.__version__}')" && \
    # Remove Windows-only TensorRT libraries to save ~500MB
    # Log what we're deleting for debugging
    echo "Removing Windows-only TensorRT libraries..." && \
    find /usr -name '*_win_*.so*' -type f 2>/dev/null | head -5 | xargs -I{} echo "  Removing: {}" && \
    find /usr -name '*_win_*.so*' -type f -delete 2>/dev/null || true && \
    find /usr -name '*_win.so*' -type f -delete 2>/dev/null || true && \
    echo "Cleanup complete"

# Runtime config
EXPOSE 8000

# Environment variables (see README for details)
ENV NETV_PORT=8000
ENV NETV_HTTPS=""
ENV LOG_LEVEL=INFO
ENV SR_ENGINE_DIR=/models

# Create non-root user
RUN useradd -m netv

# Copy entrypoint and set permissions with validation
COPY entrypoint-ai_upscale.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh && \
    test -x /app/entrypoint.sh || { echo "ERROR: entrypoint.sh not executable"; exit 1; }

# Create models directory with proper permissions (will be a volume mount point)
RUN mkdir -p /models && \
    chown netv:netv /models && \
    chmod 755 /models && \
    test -d /models && test -w /models || { echo "ERROR: /models not writable"; exit 1; }
VOLUME /models

# Healthcheck with improved error handling
# Note: start-period=60s allows time for TensorRT engine compilation on first start
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD python3 -c "import urllib.request; r=urllib.request.urlopen('http://localhost:8000/', timeout=5); exit(0 if r.status==200 else 1)" 2>/dev/null || exit 1

ENTRYPOINT ["/app/entrypoint.sh"]
